version: 2

jobs:
    build:
      docker:
        - image: circleci/golang:1.10.3
      working_directory: /go/src/github.com/tietang/props

      steps:
        - checkout
        - run: |
            wget http://www-us.apache.org/dist/zookeeper/zookeeper-3.4.10/zookeeper-3.4.10.tar.gz
            tar -zxvf zookeeper*tar.gz
            mv zookeeper-3.4.10/conf/zoo_sample.cfg zookeeper-3.4.10/conf/zoo.cfg
            zookeeper-3.4.10/bin/zkServer.sh start
            mkdir -p ./bin
            wget https://releases.hashicorp.com/consul/1.2.0/consul_1.2.0_linux_amd64.zip
            unzip consul_1.2.0_linux_amd64.zip  -d ./bin/
            wget https://github.com/coreos/etcd/releases/download/v3.3.8/etcd-v3.3.8-linux-amd64.tar.gz
            tar -zxvf etcd-v3.3.8-linux-amd64.tar.gz
            mv ./etcd-v3.3.8-linux-amd64/etcd ./bin
            pwd
            ls ./bin
            export PATH=`pwd`/bin:`pwd`:$PATH
            nohup consul agent -dev &
            nohup etcd --data-dir=./temp/etcd &
            echo $PATH
            go get -u github.com/golang/dep/cmd/dep
            dep ensure
            dep ensure -update
        - run: |
            go test -i -v -race ./...
            go test -v -coverprofile=coverage.txt -coverpkg=./... ./...